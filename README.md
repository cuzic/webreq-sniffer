# WebreqSniffer

A Chrome extension to monitor network requests and generate download scripts. Designed for capturing HLS/DASH streaming playlists and generating reusable scripts (Bash curl, yt-dlp, PowerShell).

![Version](https://img.shields.io/badge/version-0.1.0-blue)
![Manifest V3](https://img.shields.io/badge/Manifest-V3-green)
![License](https://img.shields.io/badge/license-MIT-blue)

## Features

### 🎯 Core Functionality

- **Real-time Network Monitoring**: Capture HTTP requests with webRequest API
- **Smart Filtering**: Multi-stage filtering with deny/allow lists, resource types, and custom patterns
- **HLS/DASH Optimization**: Special mode to capture only playlists (.m3u8/.mpd) while skipping segments
- **Multiple Export Formats**:
  - URL List (.txt)
  - Bash curl
  - Bash curl with headers
  - Bash yt-dlp
  - PowerShell
- **Privacy-First**: Sensitive headers (Cookie, Authorization) are OFF by default

### ⚙️ Settings & Configuration

- **Quick Presets**: One-click filters for videos, documents, and images
- **Advanced Filtering**: Simple text patterns + regex support
- **Resource Type Selection**: Filter by 14+ resource types
- **Domain Filters**: Allow/deny lists with wildcard support
- **Header Collection Policy**: Choose which headers to capture
- **Export Customization**: Filename templates with variables

### 🎨 User Interface

- **Popup**: Quick monitoring controls with status display
- **Options Page**: Comprehensive settings with tab-based organization
- **Modern UI**: Built with Tailwind CSS and shadcn/ui components

## Installation

### For Users

1. Download the latest release from [Releases](https://github.com/cuzic/webreq-sniffer/releases)
2. Unzip the downloaded file
3. Open Chrome and navigate to `chrome://extensions/`
4. Enable "Developer mode" (top right)
5. Click "Load unpacked"
6. Select the `dist` folder from the unzipped directory

### For Developers

```bash
# Clone the repository
git clone https://github.com/cuzic/webreq-sniffer.git
cd webreq-sniffer

# Install dependencies
npm install

# Build the extension
npm run build

# Load the 'dist' folder in Chrome
# chrome://extensions/ -> Load unpacked -> select 'dist' folder
```

## Usage

### Basic Workflow

1. **Open the Popup** (click extension icon)
2. **Start Monitoring**:
   - Choose scope: "Active Tab" or "All Tabs"
   - Click "監視スタート" (Start Monitoring)
3. **Browse** to the content you want to capture
4. **Export Logs**:
   - Click "ログをダウンロード" (Download Logs)
   - Select your preferred format
5. **Clear Logs** when done (optional)

### Filtering Examples

#### Capture Video Streams

```
Simple Filters:
.m3u8
.mpd
.ts
.m4s

HLS/MPD Mode: Playlist Only (recommended)
```

#### Capture Specific Domain

```
Allow List:
cdn.example.com
*.video-cdn.net

Resource Types:
✓ media
✓ xmlhttprequest
```

#### Exclude Tracking/Ads

```
Deny List:
analytics.google.com
ads.*
tracker.*
```

### Export Format Examples

#### Bash curl

```bash
#!/bin/bash
# Generated by WebreqSniffer

curl -L 'https://example.com/video/playlist.m3u8'
curl -L 'https://cdn.example.com/segment-001.ts'
```

#### Bash yt-dlp

```bash
#!/bin/bash
# Generated by WebreqSniffer

yt-dlp --add-header 'User-Agent: Mozilla/5.0' --referer 'https://example.com' 'https://example.com/video/playlist.m3u8'
```

#### PowerShell

```powershell
# Generated by WebreqSniffer
$ProgressPreference = "SilentlyContinue"

# Request 1
$headers = @{
    "User-Agent" = "Mozilla/5.0"
    "Referer" = "https://example.com"
}
Invoke-WebRequest -Uri "https://example.com/video.m3u8" -Headers $headers
```

## Development

### Tech Stack

- **Framework**: React 19 + TypeScript
- **Build Tool**: Vite + CRXJS (Chrome Extension plugin)
- **UI Library**: Tailwind CSS + shadcn/ui
- **Storage**: chrome.storage API with custom StateManager (5s cache TTL)
- **Validation**: Zod schemas for runtime type safety
- **Testing**: Vitest (524 tests passing) - comprehensive unit and E2E tests
- **Code Quality**: ESLint + Prettier + Husky
- **Design Patterns**: Factory, Observer, Chain of Responsibility, Builder, Template Method

### Project Structure

```
webreq-sniffer/
├── src/
│   ├── background/          # Service Worker
│   │   ├── index.ts         # Entry point
│   │   ├── state-manager.ts # State management with caching
│   │   ├── storage.ts       # chrome.storage wrapper
│   │   ├── messages.ts      # Message handlers
│   │   ├── listeners.ts     # webRequest listeners
│   │   ├── request-processor.ts     # Request processing coordinator
│   │   ├── request-handler-chain.ts # Chain of Responsibility pattern
│   │   ├── request-filter.ts        # Filtering logic encapsulation
│   │   ├── request-logger.ts        # Log entry management
│   │   ├── log-entry-builder.ts     # Builder pattern for LogEntry
│   │   ├── filtering.ts     # Core filtering functions
│   │   ├── logging.ts       # Log utilities
│   │   ├── export.ts        # Export script generation
│   │   └── badge.ts         # Extension badge control
│   ├── lib/                 # Shared utilities
│   │   ├── constants.ts     # Centralized constants
│   │   ├── error-handling.ts # Error handling utilities
│   │   ├── state-change-emitter.ts # Observer pattern
│   │   ├── export/
│   │   │   ├── generator-factory.ts # Factory pattern
│   │   │   └── generators/
│   │   │       └── script-generator-template.ts # Template Method
│   │   └── adapters/        # Storage adapters (Chrome/Mock)
│   ├── popup/               # Popup UI
│   │   ├── popup.tsx        # Entry point
│   │   ├── Popup.tsx        # Main component
│   │   └── messaging.ts     # Chrome messaging
│   ├── options/             # Options Page
│   │   ├── options.tsx      # Entry point
│   │   ├── Options.tsx      # Main component
│   │   ├── messaging.ts     # Chrome messaging
│   │   └── tabs/            # Tab components
│   ├── types/               # Type definitions
│   │   ├── models.ts        # TypeScript types (discriminated unions)
│   │   ├── schemas.ts       # Zod schemas
│   │   ├── guards.ts        # Type guards
│   │   └── index.ts         # Exports
│   └── components/ui/       # shadcn/ui components
├── tests/
│   ├── unit/                # Unit tests (Vitest)
│   ├── e2e/                 # E2E tests (Puppeteer)
│   └── setup/               # Setup verification tests
├── dist/                    # Build output
└── docs/                    # Documentation
```

### Build Commands

```bash
# Development build with watch mode
npm run dev

# Production build
npm run build

# Run tests
npm test

# Lint code
npm run lint

# Format code
npm run format
```

### Testing

All tests pass with TDD methodology:

- **524 tests** covering all components
  - Unit tests (511 tests): business logic, design patterns, utilities
  - E2E tests (13 tests): extension functionality, UI interactions
- Design pattern implementations with comprehensive test coverage
- Type validation tests
- Service Worker tests
- Integration tests for request processing

```bash
npm test
```

### Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## Architecture

### Design Patterns

WebreqSniffer implements **5 design patterns** for maintainability and extensibility:

1. **Factory Pattern**: Export generator creation (`ExportGeneratorFactory`)
2. **Observer Pattern**: State change notifications (`StateChangeEmitter`)
3. **Chain of Responsibility**: Request processing pipeline (`RequestHandlerChain`)
4. **Builder Pattern**: LogEntry construction (`LogEntryBuilder`)
5. **Template Method**: Script generation algorithm (`ScriptGenerator`)

See [docs/DESIGN-PATTERNS.md](docs/DESIGN-PATTERNS.md) for detailed documentation.

### Service Worker (Background)

The background service worker uses a **class-based architecture** with dependency injection and design patterns:

- **StateManager**: Manages application state with 5-second caching
- **StateChangeEmitter** (Observer): Real-time state change notifications, eliminating polling
- **RequestProcessor**: Coordinates the request processing workflow
- **RequestHandlerChain** (Chain of Responsibility): Monitoring → Filtering → Logging pipeline
- **RequestLogger**: Manages log entries with deduplication and ring buffer
- **LogEntryBuilder** (Builder): Constructs LogEntry objects with validation
- **ExportGeneratorFactory** (Factory): Creates appropriate export generators
- **Message Handlers**: Handles communication with Popup/Options pages

### Class Architecture

```
RequestProcessor
    ├── StateManager (injected)
    └── RequestHandlerChain
        ├── MonitoringCheckHandler
        ├── FilteringHandler
        └── LoggingHandler
            ├── RequestLogger (injected)
            └── LogEntryBuilder
```

### Data Flow

```
User Action (Popup)
    ↓
chrome.runtime.sendMessage
    ↓
Message Handlers (messages.ts)
    ↓
StateManager (state-manager.ts)
    ↓
webRequest Event → RequestProcessor
    ├── Check monitoring state
    ├── RequestFilter.shouldLog()
    └── RequestLogger.logRequest()
        ├── Create log entry
        ├── Check for duplicates
        ├── Apply ring buffer limit
        └── Save to storage
    ↓
Export (export.ts)
    ↓
chrome.downloads.download
```

### Filtering Pipeline

1. **Deny List Check**: Skip if URL matches deny patterns
2. **Allow List Check**: Skip if allow list exists and URL doesn't match
3. **Resource Type Filter**: Check if resource type is enabled
4. **HLS/MPD Mode**: In playlistOnly mode, skip segments (.ts, .m4s)
5. **Pattern Matching**: Check against simple/regex filters

## Privacy & Security

- **No Data Collection**: All data stays local on your device
- **Sensitive Headers OFF by Default**: Cookie and Authorization headers are not captured unless explicitly enabled
- **User Control**: You decide when to start/stop monitoring
- **Clear Logs**: Easy one-click log clearing
- **Chrome Storage**: Uses chrome.storage.local (not sent to servers)

## Permissions

This extension requires the following permissions:

- `webRequest`: To intercept and log network requests
- `storage`: To save settings and logs
- `downloads`: To export logs as files
- `activeTab`: To monitor the active tab
- `unlimitedStorage`: For large log datasets
- `<all_urls>`: To capture cross-domain requests (e.g., CDN resources)

## Roadmap

### Completed ✅

**Core Features:**

- [x] Service Worker implementation (Manifest V3)
- [x] Popup UI with React 19 + Tailwind CSS
- [x] Options Page with comprehensive settings
- [x] Export functionality (5 formats)
- [x] HLS/DASH manifest parsing
- [x] Page metadata collection

**Code Quality (Issue #64):**

- [x] Design Patterns implementation:
  - [x] Factory Pattern (Export generators)
  - [x] Observer Pattern (State change notifications)
  - [x] Chain of Responsibility (Request pipeline)
  - [x] Builder Pattern (LogEntry construction)
  - [x] Template Method (Script generators)
- [x] Comprehensive testing (524 tests, all passing)
- [x] TDD methodology for all patterns
- [x] Class-based architecture with dependency injection
- [x] Type-safe discriminated unions for messages
- [x] Constants centralization
- [x] Error handling with custom error classes
- [x] State management with caching (5s TTL)
- [x] Real-time UI updates (eliminated polling)

**Performance:**

- [x] Observer Pattern replaced 1-second polling
- [x] Code reduction: -330+ lines across multiple files
- [x] Cyclomatic complexity reduction: 4 → 1 in critical paths

### Planned 🚀

- [ ] React component optimization (React.memo, useMemo)
- [ ] Chrome Web Store publishing
- [ ] Performance optimization for large datasets (10,000+ entries)
- [ ] Expanded test coverage for custom hooks

## License

MIT License - see [LICENSE](LICENSE) file for details

## Acknowledgments

- Built with [Vite](https://vitejs.dev/) and [CRXJS](https://crxjs.dev/)
- UI components from [shadcn/ui](https://ui.shadcn.com/)
- Icons from [Lucide React](https://lucide.dev/)

## Support

- **Issues**: [GitHub Issues](https://github.com/cuzic/webreq-sniffer/issues)
- **Discussions**: [GitHub Discussions](https://github.com/cuzic/webreq-sniffer/discussions)

---

**Note**: This extension is for legal and ethical use only. Always respect website terms of service and copyright laws when downloading content.
