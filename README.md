# WebreqSniffer

A Chrome extension to monitor network requests and generate download scripts. Designed for capturing HLS/DASH streaming playlists and generating reusable scripts (Bash curl, yt-dlp, PowerShell).

![Version](https://img.shields.io/badge/version-0.1.0-blue)
![Manifest V3](https://img.shields.io/badge/Manifest-V3-green)
![License](https://img.shields.io/badge/license-MIT-blue)

## Features

### ðŸŽ¯ Core Functionality

- **Real-time Network Monitoring**: Capture HTTP requests with webRequest API
- **Smart Filtering**: Multi-stage filtering with deny/allow lists, resource types, and custom patterns
- **HLS/DASH Optimization**: Special mode to capture only playlists (.m3u8/.mpd) while skipping segments
- **Multiple Export Formats**:
  - URL List (.txt)
  - Bash curl
  - Bash curl with headers
  - Bash yt-dlp
  - PowerShell
- **Privacy-First**: Sensitive headers (Cookie, Authorization) are OFF by default

### âš™ï¸ Settings & Configuration

- **Quick Presets**: One-click filters for videos, documents, and images
- **Advanced Filtering**: Simple text patterns + regex support
- **Resource Type Selection**: Filter by 14+ resource types
- **Domain Filters**: Allow/deny lists with wildcard support
- **Header Collection Policy**: Choose which headers to capture
- **Export Customization**: Filename templates with variables

### ðŸŽ¨ User Interface

- **Popup**: Quick monitoring controls with status display
- **Options Page**: Comprehensive settings with tab-based organization
- **Modern UI**: Built with Tailwind CSS and shadcn/ui components

## Installation

### For Users

1. Download the latest release from [Releases](https://github.com/cuzic/webreq-sniffer/releases)
2. Unzip the downloaded file
3. Open Chrome and navigate to `chrome://extensions/`
4. Enable "Developer mode" (top right)
5. Click "Load unpacked"
6. Select the `dist` folder from the unzipped directory

### For Developers

```bash
# Clone the repository
git clone https://github.com/cuzic/webreq-sniffer.git
cd webreq-sniffer

# Install dependencies
npm install

# Build the extension
npm run build

# Load the 'dist' folder in Chrome
# chrome://extensions/ -> Load unpacked -> select 'dist' folder
```

## Usage

### Basic Workflow

1. **Open the Popup** (click extension icon)
2. **Start Monitoring**:
   - Choose scope: "Active Tab" or "All Tabs"
   - Click "ç›£è¦–ã‚¹ã‚¿ãƒ¼ãƒˆ" (Start Monitoring)
3. **Browse** to the content you want to capture
4. **Export Logs**:
   - Click "ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" (Download Logs)
   - Select your preferred format
5. **Clear Logs** when done (optional)

### Filtering Examples

#### Capture Video Streams

```
Simple Filters:
.m3u8
.mpd
.ts
.m4s

HLS/MPD Mode: Playlist Only (recommended)
```

#### Capture Specific Domain

```
Allow List:
cdn.example.com
*.video-cdn.net

Resource Types:
âœ“ media
âœ“ xmlhttprequest
```

#### Exclude Tracking/Ads

```
Deny List:
analytics.google.com
ads.*
tracker.*
```

### Export Format Examples

#### Bash curl

```bash
#!/bin/bash
# Generated by WebreqSniffer

curl -L 'https://example.com/video/playlist.m3u8'
curl -L 'https://cdn.example.com/segment-001.ts'
```

#### Bash yt-dlp

```bash
#!/bin/bash
# Generated by WebreqSniffer

yt-dlp --add-header 'User-Agent: Mozilla/5.0' --referer 'https://example.com' 'https://example.com/video/playlist.m3u8'
```

#### PowerShell

```powershell
# Generated by WebreqSniffer
$ProgressPreference = "SilentlyContinue"

# Request 1
$headers = @{
    "User-Agent" = "Mozilla/5.0"
    "Referer" = "https://example.com"
}
Invoke-WebRequest -Uri "https://example.com/video.m3u8" -Headers $headers
```

## Development

### Tech Stack

- **Framework**: React 19 + TypeScript
- **Build Tool**: Vite + CRXJS (Chrome Extension plugin)
- **UI Library**: Tailwind CSS + shadcn/ui
- **Storage**: chrome.storage API with custom StateManager (5s cache TTL)
- **Validation**: Zod schemas for runtime type safety
- **Testing**: Vitest (201 tests passing)
- **Code Quality**: ESLint + Prettier + Husky

### Project Structure

```
webreq-sniffer/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ background/          # Service Worker
â”‚   â”‚   â”œâ”€â”€ index.ts         # Entry point
â”‚   â”‚   â”œâ”€â”€ state-manager.ts # State management with caching
â”‚   â”‚   â”œâ”€â”€ storage.ts       # chrome.storage wrapper
â”‚   â”‚   â”œâ”€â”€ messages.ts      # Message handlers
â”‚   â”‚   â”œâ”€â”€ listeners.ts     # webRequest listeners
â”‚   â”‚   â”œâ”€â”€ request-processor.ts  # Request processing coordinator
â”‚   â”‚   â”œâ”€â”€ request-filter.ts     # Filtering logic encapsulation
â”‚   â”‚   â”œâ”€â”€ request-logger.ts     # Log entry management
â”‚   â”‚   â”œâ”€â”€ filtering.ts     # Core filtering functions
â”‚   â”‚   â”œâ”€â”€ logging.ts       # Log utilities
â”‚   â”‚   â”œâ”€â”€ export.ts        # Export script generation
â”‚   â”‚   â””â”€â”€ badge.ts         # Extension badge control
â”‚   â”œâ”€â”€ lib/                 # Shared utilities
â”‚   â”‚   â”œâ”€â”€ constants.ts     # Centralized constants
â”‚   â”‚   â”œâ”€â”€ errors.ts        # Custom error classes
â”‚   â”‚   â””â”€â”€ adapters/        # Storage adapters (Chrome/Mock)
â”‚   â”œâ”€â”€ popup/               # Popup UI
â”‚   â”‚   â”œâ”€â”€ popup.tsx        # Entry point
â”‚   â”‚   â”œâ”€â”€ Popup.tsx        # Main component
â”‚   â”‚   â””â”€â”€ messaging.ts     # Chrome messaging
â”‚   â”œâ”€â”€ options/             # Options Page
â”‚   â”‚   â”œâ”€â”€ options.tsx      # Entry point
â”‚   â”‚   â”œâ”€â”€ Options.tsx      # Main component
â”‚   â”‚   â”œâ”€â”€ messaging.ts     # Chrome messaging
â”‚   â”‚   â””â”€â”€ tabs/            # Tab components
â”‚   â”œâ”€â”€ types/               # Type definitions
â”‚   â”‚   â”œâ”€â”€ models.ts        # TypeScript types (discriminated unions)
â”‚   â”‚   â”œâ”€â”€ schemas.ts       # Zod schemas
â”‚   â”‚   â”œâ”€â”€ guards.ts        # Type guards
â”‚   â”‚   â””â”€â”€ index.ts         # Exports
â”‚   â””â”€â”€ components/ui/       # shadcn/ui components
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/                # Unit tests (Vitest)
â”‚   â”œâ”€â”€ e2e/                 # E2E tests (Puppeteer)
â”‚   â””â”€â”€ setup/               # Setup verification tests
â”œâ”€â”€ dist/                    # Build output
â””â”€â”€ docs/                    # Documentation
```

### Build Commands

```bash
# Development build with watch mode
npm run dev

# Production build
npm run build

# Run tests
npm test

# Lint code
npm run lint

# Format code
npm run format
```

### Testing

All tests pass with TDD methodology:

- **201 tests** covering all components
- Unit tests for business logic
- Integration tests for request processing
- Type validation tests
- Service Worker tests

```bash
npm test
```

### Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## Architecture

### Service Worker (Background)

The background service worker uses a **class-based architecture** with dependency injection for better testability and separation of concerns:

- **StateManager**: Manages application state with 5-second caching
- **RequestProcessor**: Coordinates the request processing workflow
- **RequestFilter**: Encapsulates filtering logic
- **RequestLogger**: Manages log entries with deduplication and ring buffer
- **Message Handlers**: Handles communication with Popup/Options pages
- **Export Module**: Generates scripts in multiple formats

### Class Architecture

```
RequestProcessor
    â”œâ”€â”€ StateManager (injected)
    â”œâ”€â”€ RequestFilter (injected)
    â””â”€â”€ RequestLogger (injected)
        â””â”€â”€ StateManager (injected)
```

### Data Flow

```
User Action (Popup)
    â†“
chrome.runtime.sendMessage
    â†“
Message Handlers (messages.ts)
    â†“
StateManager (state-manager.ts)
    â†“
webRequest Event â†’ RequestProcessor
    â”œâ”€â”€ Check monitoring state
    â”œâ”€â”€ RequestFilter.shouldLog()
    â””â”€â”€ RequestLogger.logRequest()
        â”œâ”€â”€ Create log entry
        â”œâ”€â”€ Check for duplicates
        â”œâ”€â”€ Apply ring buffer limit
        â””â”€â”€ Save to storage
    â†“
Export (export.ts)
    â†“
chrome.downloads.download
```

### Filtering Pipeline

1. **Deny List Check**: Skip if URL matches deny patterns
2. **Allow List Check**: Skip if allow list exists and URL doesn't match
3. **Resource Type Filter**: Check if resource type is enabled
4. **HLS/MPD Mode**: In playlistOnly mode, skip segments (.ts, .m4s)
5. **Pattern Matching**: Check against simple/regex filters

## Privacy & Security

- **No Data Collection**: All data stays local on your device
- **Sensitive Headers OFF by Default**: Cookie and Authorization headers are not captured unless explicitly enabled
- **User Control**: You decide when to start/stop monitoring
- **Clear Logs**: Easy one-click log clearing
- **Chrome Storage**: Uses chrome.storage.local (not sent to servers)

## Permissions

This extension requires the following permissions:

- `webRequest`: To intercept and log network requests
- `storage`: To save settings and logs
- `downloads`: To export logs as files
- `activeTab`: To monitor the active tab
- `unlimitedStorage`: For large log datasets
- `<all_urls>`: To capture cross-domain requests (e.g., CDN resources)

## Roadmap

### Completed âœ…

- [x] Service Worker implementation
- [x] Popup UI
- [x] Options Page
- [x] Export functionality (5 formats)
- [x] Unit tests with Vitest (201 tests)
- [x] Class-based architecture with dependency injection
- [x] Type-safe discriminated unions for messages
- [x] Constants centralization
- [x] Error handling with custom error classes
- [x] State management with caching (5s TTL)

### Planned ðŸš€

- [ ] E2E tests with Puppeteer
- [ ] Chrome Web Store publishing
- [ ] Performance optimization for large datasets

## License

MIT License - see [LICENSE](LICENSE) file for details

## Acknowledgments

- Built with [Vite](https://vitejs.dev/) and [CRXJS](https://crxjs.dev/)
- UI components from [shadcn/ui](https://ui.shadcn.com/)
- Icons from [Lucide React](https://lucide.dev/)

## Support

- **Issues**: [GitHub Issues](https://github.com/cuzic/webreq-sniffer/issues)
- **Discussions**: [GitHub Discussions](https://github.com/cuzic/webreq-sniffer/discussions)

---

**Note**: This extension is for legal and ethical use only. Always respect website terms of service and copyright laws when downloading content.
